<div class="language-switcher">
    <span class="lang-switch-title">{{ site.data.i18n[site.active_lang].lang_switcher.change_lang }}</span>
    <div class="lang-dropdown">
        <button id="langDropdownBtn" class="dropdown-btn">
            <span id="currentLangIcon" class="lang-icon">ğŸ‡°ğŸ‡·</span>
            <span id="currentLangText" class="lang-text">í•œêµ­ì–´</span>
            <span class="dropdown-arrow">â–¼</span>
        </button>
        <div id="langDropdownContent" class="dropdown-content">
            {% if site.active_lang == 'en' %}
            {% comment %} ì˜ì–´ì—ì„œ í•œêµ­ì–´ë¡œ ì „í™˜ {% endcomment %}
            {% assign ko_url = page.url | replace_first: '/en', '' %}
            {% if ko_url == '' %}
            {% assign ko_url = '/' %}
            {% endif %}
            <a href="{{ ko_url }}" class="ko-lang {% if site.active_lang == 'ko' %}active{% endif %}" data-lang="ko">
                <span class="lang-icon">ğŸ‡°ğŸ‡·</span>
                <span class="lang-text">í•œêµ­ì–´</span>
            </a>
            <a href="{{ page.url }}" class="en-lang {% if site.active_lang == 'en' %}active{% endif %}" data-lang="en">
                <span class="lang-icon">ğŸ‡ºğŸ‡¸</span>
                <span class="lang-text">English</span>
            </a>
            {% else %}
            {% comment %} í•œêµ­ì–´ì—ì„œ ì˜ì–´ë¡œ ì „í™˜ {% endcomment %}
            <a href="{{ page.url }}" class="ko-lang {% if site.active_lang == 'ko' %}active{% endif %}" data-lang="ko">
                <span class="lang-icon">ğŸ‡°ğŸ‡·</span>
                <span class="lang-text">í•œêµ­ì–´</span>
            </a>
            {% assign en_url = '/en' | append: page.url %}
            <a href="{{ en_url }}" class="en-lang {% if site.active_lang == 'en' %}active{% endif %}" data-lang="en">
                <span class="lang-icon">ğŸ‡ºğŸ‡¸</span>
                <span class="lang-text">English</span>
            </a>
            {% endif %}
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ê¸°ë³¸ ì–¸ì–´ ì„¤ì • (í•œêµ­ì–´)
        const defaultLang = 'ko';

        // ì–¸ì–´ ì „í™˜ ë“œë¡­ë‹¤ìš´ í† ê¸€ ì²˜ë¦¬
        const dropdownBtn = document.getElementById('langDropdownBtn');
        const dropdownContent = document.getElementById('langDropdownContent');
        const currentLangIcon = document.getElementById('currentLangIcon');
        const currentLangText = document.getElementById('currentLangText');

        if (dropdownBtn) {
            dropdownBtn.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                dropdownContent.classList.toggle('show');
            });
        }

        // ë¬¸ì„œ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.language-switcher')) {
                if (dropdownContent && dropdownContent.classList.contains('show')) {
                    dropdownContent.classList.remove('show');
                }
            }
        });

        // ì¿ í‚¤ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function getCookie(name) {
            let value = `; ${document.cookie}`;
            let parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                let date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Lax";
        }

        // URL ì •ê·œí™” í•¨ìˆ˜
        function normalizeUrl(url, targetLang) {
            // í˜„ì¬ URL ê°€ì ¸ì˜¤ê¸°
            let currentPath = window.location.pathname;
            let newUrl = '';

            if (targetLang === 'en') {
                // ì´ë¯¸ /enìœ¼ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸
                if (currentPath.startsWith('/en/')) {
                    newUrl = currentPath; // ì´ë¯¸ ì˜ì–´ ê²½ë¡œë©´ ìœ ì§€
                } else if (currentPath === '/') {
                    newUrl = '/en/'; // í™ˆí˜ì´ì§€ì¸ ê²½ìš°
                } else {
                    // /en/ ì ‘ë‘ì‚¬ ì¶”ê°€
                    newUrl = '/en' + currentPath;
                }

                // ì¤‘ë³µëœ /en/en/ íŒ¨í„´ ì œê±°
                newUrl = newUrl.replace(/\/en\/en\//g, '/en/');
            } else {
                // ì˜ì–´ì—ì„œ í•œêµ­ì–´ë¡œ ë³€ê²½í•˜ëŠ” ê²½ìš° /en ì œê±°
                newUrl = currentPath.replace(/^\/en/, '');
                if (newUrl === '') newUrl = '/';
            }

            return newUrl;
        }

        // ì–¸ì–´ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        const langButtons = document.querySelectorAll('.dropdown-content a');
        if (langButtons) {
            langButtons.forEach(function (btn) {
                btn.addEventListener('click', function (e) {
                    e.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€

                    const lang = this.getAttribute('data-lang');
                    const newUrl = normalizeUrl(window.location.pathname, lang);

                    // ì–¸ì–´ ë³€ê²½ ì‹œ ì¿ í‚¤ ì €ì¥ (365ì¼ ìœ ì§€)
                    setCookie('preferred_lang', lang, 365);

                    // í˜ì´ì§€ ì´ë™
                    window.location.href = newUrl;
                });
            });
        }

        // ì¿ í‚¤ì—ì„œ ì„ í˜¸ ì–¸ì–´ í™•ì¸
        function getPreferredLanguage() {
            // ì¿ í‚¤ì—ì„œ ì–¸ì–´ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
            const cookieLang = getCookie('preferred_lang');

            // ì¿ í‚¤ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì–¸ì–´, ì—†ìœ¼ë©´ URLì—ì„œ ê°ì§€
            if (cookieLang) {
                return cookieLang;
            }

            // URLì—ì„œ ì–¸ì–´ í™•ì¸
            return window.location.pathname.startsWith('/en/') ? 'en' : 'ko';
        }

        // í˜„ì¬ ì–¸ì–´ì™€ URLì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        function checkLanguageRedirect() {
            const preferredLang = getPreferredLanguage();
            const currentUrl = window.location.pathname;
            const isEnglishUrl = currentUrl.startsWith('/en/');

            // ì„ í˜¸ ì–¸ì–´ê°€ ì˜ì–´ì¸ë° URLì— /en/ì´ ì—†ê±°ë‚˜ 
            // ì„ í˜¸ ì–¸ì–´ê°€ í•œêµ­ì–´ì¸ë° URLì— /en/ì´ ìˆìœ¼ë©´ ë¦¬ë‹¤ì´ë ‰íŠ¸
            if ((preferredLang === 'en' && !isEnglishUrl) ||
                (preferredLang === 'ko' && isEnglishUrl)) {

                const redirectUrl = normalizeUrl(currentUrl, preferredLang);
                // ë¬´í•œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ë°©ì§€ë¥¼ ìœ„í•œ ì¿ í‚¤ ì„¤ì •
                if (!getCookie('redirected')) {
                    setCookie('redirected', 'true', 1 / 1440); // 1ë¶„ê°„ ìœ ì§€
                    window.location.href = redirectUrl;
                }
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì–¸ì–´ ì²´í¬ ë° ë¦¬ë‹¤ì´ë ‰íŠ¸
        checkLanguageRedirect();

        // í˜„ì¬ ì–¸ì–´ ê°ì§€ ë° ì„¤ì •
        function updateLanguageUI() {
            // í˜„ì¬ ì„ í˜¸ ì–¸ì–´ ê°€ì ¸ì˜¤ê¸°
            const currentLang = getPreferredLanguage();

            // í˜„ì¬ ì–¸ì–´ì— ë”°ë¼ ë“œë¡­ë‹¤ìš´ ë²„íŠ¼ ì—…ë°ì´íŠ¸
            if (currentLang === 'en') {
                currentLangIcon.textContent = 'ğŸ‡ºğŸ‡¸';
                currentLangText.textContent = 'English';
            } else {
                currentLangIcon.textContent = 'ğŸ‡°ğŸ‡·';
                currentLangText.textContent = 'í•œêµ­ì–´';
            }

            // HTML lang ì†ì„± ì„¤ì •
            document.documentElement.setAttribute('lang', currentLang);

            // ì–¸ì–´ ì „í™˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            const koLangBtn = document.querySelector('.ko-lang');
            const enLangBtn = document.querySelector('.en-lang');

            if (currentLang === 'ko') {
                if (koLangBtn) koLangBtn.classList.add('active');
                if (enLangBtn) enLangBtn.classList.remove('active');
            } else {
                if (koLangBtn) koLangBtn.classList.remove('active');
                if (enLangBtn) enLangBtn.classList.add('active');
            }

            // ì–¸ì–´ ë³€ê²½ ì´ë²¤íŠ¸ ë°œìƒ - ë©”ë‰´ì™€ í˜ì´ì§€ ë‚´ìš©ì„ ì—…ë°ì´íŠ¸í•˜ê¸° ìœ„í•´
            document.dispatchEvent(new CustomEvent('languageChanged', {
                detail: { language: currentLang }
            }));
        }

        // UI ì—…ë°ì´íŠ¸
        updateLanguageUI();

        // ë¦¬ë‹¤ì´ë ‰íŠ¸ ì¿ í‚¤ í´ë¦¬ì–´ (ë‹¤ìŒ í˜ì´ì§€ì—ì„œ ë‹¤ì‹œ ì²´í¬í•  ìˆ˜ ìˆë„ë¡)
        setTimeout(function () {
            setCookie('redirected', '', -1);
        }, 3000);
    });
</script>

<style>
    .language-switcher {
        position: relative;
        display: inline-flex;
        flex-direction: column;
        align-items: flex-end;
        margin: 0 1rem;
    }

    .lang-switch-title {
        font-size: 0.8rem;
        margin-bottom: 0.25rem;
        color: #666;
    }

    .lang-dropdown {
        position: relative;
    }

    .dropdown-btn {
        display: flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        text-decoration: none;
        color: #333;
        background-color: #f5f5f5;
        transition: background-color 0.2s;
        font-size: 0.85rem;
    }

    .dropdown-btn:hover {
        background-color: #e0e0e0;
        text-decoration: none;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        background-color: #f9f9f9;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
        z-index: 1;
    }

    .dropdown-content a {
        color: black;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
    }

    .dropdown-content a:hover {
        background-color: #f1f1f1;
    }

    .lang-icon {
        margin-right: 5px;
    }

    @media (max-width: 767px) {
        .lang-text {
            display: none;
        }

        .dropdown-btn {
            padding: 0.25rem;
        }

        .lang-icon {
            margin-right: 0;
        }
    }
</style>