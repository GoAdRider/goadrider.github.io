<!-- start custom head snippets -->

<!-- Google Font 로드 - 비동기 로딩으로 변경 -->
{% if site.lang == "ko" or page.lang == "ko" %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet"
    media="print" onload="this.media='all'">
{% endif %}

<!-- 검색 기능 스크립트 로드 - 비동기 실행으로 변경 -->
{% if site.search == true %}
<!-- 기본 Lunr 라이브러리 - 필수 -->
<script src="{{ '/assets/js/lunr/lunr.min.js' | relative_url }}" defer></script>

<!-- 검색 데이터 스토어 (스크립트 의존성) -->
<script src="{{ '/assets/js/lunr/lunr-store-static.js' | relative_url }}" defer></script>

<!-- 언어별 검색 스크립트 로드 (지연 로딩) -->
<script>
    // 페이지 렌더링 후 검색 스크립트 지연 로딩
    window.addEventListener('DOMContentLoaded', function () {
        // 검색 스크립트 로딩 상태 관리
        var searchScriptLoaded = false;

        // 스크립트 로딩 최적화를 위해 5초 지연
        setTimeout(function () {
            try {
                // 현재 언어 확인
                var lang = document.documentElement.lang || 'en';
                var scriptLanguage = lang === 'ko' ? 'ko' : 'en';

                // 스크립트 존재 확인 (이미 로드된 경우 방지)
                if (document.querySelector('script[src*="lunr-' + scriptLanguage + '.js"]')) {
                    return;
                }

                // 스크립트 생성 및 로드
                var script = document.createElement('script');
                script.src = "{{ '/assets/js/lunr/lunr-' | relative_url }}" + scriptLanguage + ".js";
                script.defer = true;
                script.async = true; // 비동기 로딩
                document.body.appendChild(script);

                searchScriptLoaded = true;
                console.log('검색 스크립트 로드: ' + scriptLanguage);
            } catch (e) {
                console.error('검색 스크립트 로드 오류:', e);
            }
        }, 1000);

        // 언어 변경 시 스크립트 재로드
        document.addEventListener('languageChanged', function (e) {
            try {
                if (!e.detail || !e.detail.language) return;

                var scriptLanguage = e.detail.language === 'ko' ? 'ko' : 'en';

                // 이전 스크립트 제거
                var oldScript = document.querySelector('script[src*="lunr-ko.js"], script[src*="lunr-en.js"]');
                if (oldScript) {
                    oldScript.remove();
                }

                // 새 스크립트 로드
                var script = document.createElement('script');
                script.src = "{{ '/assets/js/lunr/lunr-' | relative_url }}" + scriptLanguage + ".js";
                script.defer = true;
                script.async = true;
                document.body.appendChild(script);

                console.log('언어 변경으로 검색 스크립트 업데이트: ' + scriptLanguage);
            } catch (e) {
                console.error('언어 변경 시 스크립트 로드 오류:', e);
            }
        });
    });
</script>
{% endif %}

<!-- Google Analytics - 비동기로 변경 -->
{% if jekyll.environment == 'production' and site.analytics.provider and page.analytics != false %}
{% include analytics.html %}
{% endif %}

<!-- Favicon -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">

<!-- end custom head snippets -->

<!-- 글로벌 스크립트 - 페이지 로드 전에 실행됨 (지연 로딩으로 변경) -->
<script src="{{ '/assets/js/global.js' | relative_url }}" defer></script>

<!-- Safe Mode Script - 사이트 응답성 보장 -->
<script>
    // 무한 루프 방지 타임아웃 설정
    setTimeout(function () {
        // 페이지가 10초 이상 로딩 중이면 자동으로 복구 시도
        if (document.readyState !== 'complete') {
            console.log('페이지 로딩 지연 감지, 복구 시도 중...');

            // 문제 식별 - 콘솔에 메시지 출력
            console.warn('페이지 응답성 문제가 감지되었습니다.');

            // 이벤트 리스너 등록 - 페이지 로드 완료 시 알림
            window.addEventListener('load', function () {
                console.log('페이지 로딩 완료 (안전 모드)');
            });
        }
    }, 10000);
</script>