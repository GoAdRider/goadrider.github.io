<!-- 언어 전환 버튼 -->
{% assign current_lang = site.lang | default: 'ko' %}
<div class="language-toggle-container">
    <button id="language-toggle" class="language-toggle">
        {% if current_lang == 'ko' %}EN{% else %}KO{% endif %}
    </button>
</div>

<style>
    .language-toggle-container {
        display: inline-block;
        margin-left: 1rem;
    }

    .language-toggle {
        background-color: #2563eb;
        color: white;
        border: none;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.8rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
    }

    .language-toggle:hover {
        background-color: #1d4ed8;
        transform: translateY(-1px);
    }

    .language-toggle:active {
        transform: translateY(1px);
    }

    /* 효과 추가 */
    .language-toggle::after {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: -100%;
        background: rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }

    .language-toggle:hover::after {
        left: 0;
    }
</style>

<script>
    // 언어 토글 버튼 초기화 및 강화
    document.addEventListener('DOMContentLoaded', function () {
        var toggleButton = document.getElementById('language-toggle');
        if (!toggleButton) return;

        // 현재 언어에 따라 버튼 텍스트 설정
        var currentLang = localStorage.getItem('lang') || 'ko';
        toggleButton.textContent = currentLang === 'ko' ? 'EN' : 'KO';

        // 클릭 이벤트에 직접 DOM 조작 추가
        toggleButton.addEventListener('click', function () {
            // 버튼 클릭 효과
            toggleButton.classList.add('active');
            setTimeout(function () {
                toggleButton.classList.remove('active');
            }, 300);

            // 현재 언어 확인
            var currentLang = localStorage.getItem('lang') || 'ko';
            var newLang = currentLang === 'ko' ? 'en' : 'ko';

            console.log('[토글버튼] 언어 전환 시작:', currentLang, '->', newLang);

            // 1. localStorage 업데이트
            localStorage.setItem('lang', newLang);
            localStorage.setItem('preferred_language', newLang);

            // 2. 버튼 텍스트 업데이트
            toggleButton.textContent = newLang === 'ko' ? 'EN' : 'KO';

            // 3. HTML 속성 설정
            document.documentElement.lang = newLang;
            document.documentElement.setAttribute('lang', newLang);
            document.documentElement.setAttribute('data-lang', newLang);

            // 4. 언어 전환 이벤트 발생
            document.dispatchEvent(new CustomEvent('languageChanged', {
                detail: { language: newLang }
            }));

            // 5. 콘텐츠 직접 전환 시도 (폴백)
            setTimeout(function () {
                console.log('[토글버튼] 언어 전환 확인 중');

                var hasKoreanContent = document.querySelectorAll('.post-content-ko').length > 0;
                var hasEnglishContent = document.querySelectorAll('.post-content-en').length > 0;

                // 포스트 페이지인 경우
                if (hasKoreanContent || hasEnglishContent) {
                    console.log('[토글버튼] 포스트 콘텐츠 감지, 직접 전환 시도');

                    // 포스트 콘텐츠 직접 전환
                    if (newLang === 'ko') {
                        // 한국어 콘텐츠 표시
                        document.querySelectorAll('.post-content-ko').forEach(function (el) {
                            el.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
                        });
                        // 영어 콘텐츠 숨김
                        document.querySelectorAll('.post-content-en').forEach(function (el) {
                            el.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important;';
                        });
                    } else {
                        // 영어 콘텐츠 표시
                        document.querySelectorAll('.post-content-en').forEach(function (el) {
                            el.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
                        });
                        // 한국어 콘텐츠 숨김
                        document.querySelectorAll('.post-content-ko').forEach(function (el) {
                            el.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important;';
                        });
                    }

                    // 추가 디버깅 도구 사용
                    if (window.languageDiagnostics) {
                        console.log('[토글버튼] languageDiagnostics 사용');
                        if (newLang === 'ko') {
                            window.languageDiagnostics.forceKorean();
                        } else {
                            window.languageDiagnostics.forceEnglish();
                        }
                    }
                }

                // 다국어 텍스트 업데이트
                document.querySelectorAll('[data-ko][data-en]').forEach(function (el) {
                    el.textContent = el.getAttribute(newLang === 'ko' ? 'data-ko' : 'data-en');

                    // 태그 링크의 경우 '#' 추가
                    if (el.closest('.tag-link')) {
                        const tagSymbol = el.closest('.tag-link').querySelector('.tag-symbol');
                        if (!tagSymbol) {
                            el.textContent = '#' + el.textContent;
                        }
                    }
                });

                console.log('[토글버튼] 언어 전환 완료');
            }, 100);
        });
    });
</script>