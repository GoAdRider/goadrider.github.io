<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>언어 전환 디버깅</title>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 5px;
        }

        button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background-color: #3b78e7;
        }

        .test-buttons {
            margin-top: 20px;
        }

        .language-switcher {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            cursor: pointer;
            display: inline-flex;
            margin-bottom: 20px;
            background: none;
            font-family: inherit;
            font-size: inherit;
        }

        .language-switcher i {
            color: #4285f4;
        }

        .status {
            margin-top: 20px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }

        .console {
            background-color: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
        }

        .hidden {
            display: none;
        }
    </style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
</head>

<body>
    <h1 data-ko="언어 전환 디버깅 페이지" data-en="Language Switching Debug Page">언어 전환 디버깅 페이지</h1>

    <button class="language-switcher" id="language-switcher" data-initialized="true" type="button">
        <i class="fas fa-globe"></i>
        <span id="current-lang" data-ko="한국어" data-en="English">한국어</span>
    </button>

    <section id="section1">
        <h2 data-ko="문제 진단" data-en="Problem Diagnosis">문제 진단</h2>
        <div class="test-buttons">
            <button id="fix-language-switcher">이벤트 강제 복구</button>
            <button id="check-event-listeners">이벤트 리스너 확인</button>
            <button id="direct-change-ko">한국어 직접 변경</button>
            <button id="direct-change-en">영어 직접 변경</button>
            <button id="check-dom">DOM 요소 확인</button>
            <button id="force-reload">강제 새로고침</button>
        </div>
    </section>

    <section id="section2">
        <h2 data-ko="상태 및 정보" data-en="Status and Info">상태 및 정보</h2>
        <div id="status-display" class="status"></div>
        <div id="console-log" class="console"></div>
    </section>

    <script>
        // 콘솔 로그 재정의 - 화면에도 출력
        const originalConsoleLog = console.log;
        const originalConsoleWarn = console.warn;
        const originalConsoleError = console.error;
        const consoleDisplay = document.getElementById('console-log');

        console.log = function () {
            if (consoleDisplay) {
                const args = Array.from(arguments);
                const log = document.createElement('div');
                log.textContent = args.join(' ');
                consoleDisplay.appendChild(log);
                consoleDisplay.scrollTop = consoleDisplay.scrollHeight;
            }
            originalConsoleLog.apply(console, arguments);
        };

        console.warn = function () {
            if (consoleDisplay) {
                const args = Array.from(arguments);
                const log = document.createElement('div');
                log.style.color = 'yellow';
                log.textContent = '⚠️ ' + args.join(' ');
                consoleDisplay.appendChild(log);
                consoleDisplay.scrollTop = consoleDisplay.scrollHeight;
            }
            originalConsoleWarn.apply(console, arguments);
        };

        console.error = function () {
            if (consoleDisplay) {
                const args = Array.from(arguments);
                const log = document.createElement('div');
                log.style.color = 'red';
                log.textContent = '❌ ' + args.join(' ');
                consoleDisplay.appendChild(log);
                consoleDisplay.scrollTop = consoleDisplay.scrollHeight;
            }
            originalConsoleError.apply(console, arguments);
        };

        // 상태 표시 함수
        function updateStatus() {
            const statusDisplay = document.getElementById('status-display');
            if (!statusDisplay) return;

            const currentLang = localStorage.getItem('preferred_language') || localStorage.getItem('lang') || 'ko';
            const htmlLang = document.documentElement.lang;
            const currentLangText = document.getElementById('current-lang')?.textContent;

            statusDisplay.innerHTML = `
                <strong>현재 언어:</strong> ${currentLang}<br>
                <strong>HTML lang 속성:</strong> ${htmlLang}<br>
                <strong>스위처 표시 텍스트:</strong> ${currentLangText || '없음'}<br>
                <strong>localStorage.lang:</strong> ${localStorage.getItem('lang') || '없음'}<br>
                <strong>localStorage.preferred_language:</strong> ${localStorage.getItem('preferred_language') || '없음'}<br>
            `;
        }

        // 언어 변경 함수
        function updateElementLanguage(lang) {
            // 모든 다국어 요소 업데이트
            document.querySelectorAll('[data-ko][data-en]').forEach(el => {
                const newText = el.getAttribute(`data-${lang}`);

                // DOM 노드 교체 방식으로 텍스트 업데이트
                while (el.firstChild) {
                    el.removeChild(el.firstChild);
                }
                el.appendChild(document.createTextNode(newText));
            });

            // HTML lang 속성 설정
            document.documentElement.lang = lang;

            // 상태 업데이트
            updateStatus();
        }

        // 이벤트 처리 설정
        document.addEventListener('DOMContentLoaded', function () {
            console.log('디버깅 페이지 초기화됨');

            // 초기 상태 표시
            updateStatus();

            // 이벤트 리스너 복구
            document.getElementById('fix-language-switcher').addEventListener('click', function () {
                const languageSwitcher = document.getElementById('language-switcher');
                if (!languageSwitcher) {
                    console.error('언어 스위처 요소를 찾을 수 없음');
                    return;
                }

                // 기존 이벤트 리스너 제거를 위해 클론 교체
                const clone = languageSwitcher.cloneNode(true);
                languageSwitcher.parentNode.replaceChild(clone, languageSwitcher);

                // 새 이벤트 리스너 추가
                clone.addEventListener('click', function (e) {
                    console.log('언어 스위처 클릭됨 (새 이벤트 리스너)');

                    // 현재 언어 확인
                    const currentLang = localStorage.getItem('preferred_language') || localStorage.getItem('lang') || 'ko';
                    // 새 언어 설정 (한국어 <-> 영어)
                    const newLang = currentLang === 'en' ? 'ko' : 'en';

                    console.log(`언어 변경: ${currentLang} -> ${newLang}`);

                    // 스토리지 업데이트
                    localStorage.setItem('preferred_language', newLang);
                    localStorage.setItem('lang', newLang);

                    // UI 업데이트
                    updateElementLanguage(newLang);

                    // 전역 이벤트 발생
                    window.dispatchEvent(new CustomEvent('languageChange', {
                        detail: { language: newLang }
                    }));

                    document.dispatchEvent(new CustomEvent('languageChanged', {
                        detail: { language: newLang }
                    }));

                    // URL 업데이트
                    try {
                        const url = new URL(window.location);
                        url.searchParams.set('lang', newLang);
                        window.history.pushState({}, '', url);
                    } catch (e) {
                        console.error('URL 업데이트 오류:', e);
                    }
                });

                console.log('언어 스위처 이벤트 리스너 복구 완료');
            });

            // 이벤트 리스너 확인
            document.getElementById('check-event-listeners').addEventListener('click', function () {
                const languageSwitcher = document.getElementById('language-switcher');
                if (!languageSwitcher) {
                    console.error('언어 스위처 요소를 찾을 수 없음');
                    return;
                }

                console.log('언어 스위처 요소 속성:');
                console.log('- ID: ' + languageSwitcher.id);
                console.log('- className: ' + languageSwitcher.className);
                console.log('- tagName: ' + languageSwitcher.tagName);
                console.log('- data-initialized: ' + languageSwitcher.getAttribute('data-initialized'));

                // 수동으로 클릭 이벤트 발생
                console.log('수동으로 클릭 이벤트 발생시키기');
                languageSwitcher.click();
            });

            // 직접 언어 변경
            document.getElementById('direct-change-ko').addEventListener('click', function () {
                console.log('한국어 직접 변경');
                localStorage.setItem('preferred_language', 'ko');
                localStorage.setItem('lang', 'ko');
                updateElementLanguage('ko');
            });

            document.getElementById('direct-change-en').addEventListener('click', function () {
                console.log('영어 직접 변경');
                localStorage.setItem('preferred_language', 'en');
                localStorage.setItem('lang', 'en');
                updateElementLanguage('en');
            });

            // DOM 요소 확인
            document.getElementById('check-dom').addEventListener('click', function () {
                const currentLang = document.getElementById('current-lang');
                if (!currentLang) {
                    console.error('current-lang 요소를 찾을 수 없음');
                    return;
                }

                console.log('current-lang 요소 정보:');
                console.log('- textContent: ' + currentLang.textContent);
                console.log('- data-ko: ' + currentLang.getAttribute('data-ko'));
                console.log('- data-en: ' + currentLang.getAttribute('data-en'));
                console.log('- innerHTML: ' + currentLang.innerHTML);
                console.log('- outerHTML: ' + currentLang.outerHTML);

                // 노드 복제 및 교체 테스트
                const clone = currentLang.cloneNode(true);
                currentLang.parentNode.replaceChild(clone, currentLang);
                console.log('current-lang 요소 복제 및 교체 완료');
            });

            // 강제 새로고침
            document.getElementById('force-reload').addEventListener('click', function () {
                console.log('페이지 강제 새로고침');
                window.location.reload();
            });

            // 언어 스위처 리스너 설정
            const languageSwitcher = document.getElementById('language-switcher');
            if (languageSwitcher) {
                languageSwitcher.addEventListener('click', function () {
                    console.log('언어 스위처 클릭됨 (초기 이벤트 리스너)');

                    // 현재 언어 확인
                    const currentLang = localStorage.getItem('preferred_language') || localStorage.getItem('lang') || 'ko';
                    // 새 언어 설정 (한국어 <-> 영어)
                    const newLang = currentLang === 'en' ? 'ko' : 'en';

                    console.log(`언어 변경: ${currentLang} -> ${newLang}`);

                    // 스토리지 업데이트
                    localStorage.setItem('preferred_language', newLang);
                    localStorage.setItem('lang', newLang);

                    // UI 업데이트
                    updateElementLanguage(newLang);
                });
            }

            // 언어 변경 이벤트 리스너
            window.addEventListener('languageChange', function (e) {
                console.log('languageChange 이벤트 발생:', e.detail.language);
                updateElementLanguage(e.detail.language);
            });

            document.addEventListener('languageChanged', function (e) {
                console.log('languageChanged 이벤트 발생:', e.detail.language);
                updateElementLanguage(e.detail.language);
            });
        });
    </script>
</body>

</html>